<!DOCTYPE html>
<html>
<head>
    <title>Partida {{ partida_id }}</title>
    <script>
        let socket = null;
        let peerConnection = null;
    
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById("videoPreview").srcObject = stream;
    
                // Cria PeerConnection
                peerConnection = new RTCPeerConnection();
                stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
    
                // Envia candidatos ICE
                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        socket.send(JSON.stringify({ type: "ice-candidate", candidate: event.candidate }));
                    }
                };
    
                // Cria oferta para o espectador
                peerConnection.onnegotiationneeded = async () => {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    socket.send(JSON.stringify({ type: "offer", offer: offer }));
                };
    
            } catch (err) {
                alert("Erro ao acessar a câmera: " + err.message);
            }
        }
    
        function toggleCameraSource() {
            const usarCelular = document.getElementById("usarCelular").checked;
            const linkCelular = document.getElementById("linkCelular");
            const preview = document.getElementById("preview");
    
            if (usarCelular) {
                linkCelular.style.display = "block";
                preview.style.display = "none";
            } else {
                linkCelular.style.display = "none";
                preview.style.display = "block";
                startCamera();
            }
        }
    
        window.onload = () => {
            socket = new WebSocket(`ws://${location.host}/ws/{{ partida_id }}`);
            socket.onmessage = async (event) => {
                const msg = JSON.parse(event.data);
    
                if (msg.type === "answer") {
                    const remoteDesc = new RTCSessionDescription(msg.answer);
                    await peerConnection.setRemoteDescription(remoteDesc);
                } else if (msg.type === "ice-candidate" && peerConnection) {
                    try {
                        await peerConnection.addIceCandidate(msg.candidate);
                    } catch (e) {
                        console.error('Erro ao adicionar ICE candidate', e);
                    }
                }
            };
    
            toggleCameraSource();
        };
    </script>    
</head>
<body>
    <h2>Partida: {{ partida_id }}</h2>
    <p>Jogador: {{ user }}</p>
    <label>
        <input type="checkbox" id="usarCelular" onchange="toggleCameraSource()"> Usar câmera do celular
    </label>

    <div id="linkCelular" style="display:none; margin-top:10px;">
        <p>Abra no celular: <a href="/camera/{{ partida_id }}" target="_blank">/camera/{{ partida_id }}</a></p>
    </div>

    <div id="preview" style="margin-top:20px;">
        <video id="videoPreview" autoplay playsinline width="400"></video>
    </div>
</body>
</html>
